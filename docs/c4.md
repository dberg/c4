## 1.0 C4

C4 is a set tools for editing java projects in emacs.

The project includes an emacs mode c4-mode; a server that processes project files; and parsers for java and jvm bytecode.


## 2.0 Client-Server

The current client implementation of c4 is the emacs c4-mode. Different clients for different editors or tools can be written by following the protocol defined in the Data stream, Request and Response sections. The server can be initialized by running c4 with the --server option. Run c4 --help for more information.

The c4 server tracks client projects identified by a project id. The client is responsible for generating a project id and to decide which files from a project should be sent to the server.

At any point the client can query the server for a project status. A project status contains error information and a list of missing symbols and compilation units that the client should send to the server in order for the server build a complete view of the project.

The server uses non-blocking I/O (epoll or kqueue) to communicate with a client. The data is serialized and deserialized using Protocol Buffers.

The server maintains a RequestBuffer object per connection while receiving data from the client. Every time the server feeds data to the RequestBuffer it checks if a complete request can be built and once that is done, the server delivers the request to the ProjectHandler object.

The ProjectHandler object is responsible to deliver the request to its project, which is defined by the project id. If no project exists the ProjectHandler creates one.

The project process the request and returns a response object to the server which in turn delivers the response to the client.


### 2.1 Data stream

The bytestream sent between the client and the server is serialized and deserialized using the auto-generated classes Request and Response. The first 4 bytes in the bytestream, in network byte order, indicates the length of the serialized Request or Response.


###  2.2 Request

Every request must set the attributes "projectId" and "action". The projectId attribute must be generated by the client and it should be unique per project. The action attribute can be of two types: PROJECT and COMPILE.

PROJECT: A client issues this method to query the status of the project. The server will indicate if it has all the compilation units of the project and if not which symbols are missing and hints of filenames that the client should look for and send to the server.

COMPILE: The client issues this method to send a compilation unit to be parsed by the project. The compilation unit requires a filename and a buffer containing the source code of the compilation unit.


### 2.3 Response

A response consists of a response code and a body. The response code indicates if a request terminated in success or error.

Successful response codes are OK_PROJECT and OK_COMPILE.

If an error occurs the response code is set to ERROR and the body contains a human readable error message.


#### 2.3.1 Response OK_PROJECT

The body of the response contains information about the project.


#### 2.3.2 Response OK_COMPILE:

The response body contains information about the compilation unit sent to be processed.

Example of a java compilation unit:

```elisp
[(c4j-sh-keyword 1 7)(c4j-sh-keyword 8 13)(c4j-sh-reference-type-id 14 15)]
[]
[(_comp_unit 0 0 0 0)(_class 0 0 67 0)(id 1 13 14 0 A)(_method 1 21 65 1)]
#s(hash-table size 1 data (0 (0 0 0) ))
```

Each line indicates a different type of information for the buffer and that the emacs mode should evaluate. The first line contains syntax highlighting information. The second line contains any errors found while parsing the buffer. The third line is the symbol table. The fourth line contains indentation positions for each line in the buffer.


## 3.0 Projects

A project instance is identified by a projectId that is generated by the client. A project is a global container for 2 specialized sub-projects: JavaProject and BytecodeProject.

A java project instance contains a list of compilation units. Each compilation unit is identified by its filename. After being processed the compilation unit object should have a symbol table and basic information about the source file like syntax highlighting and the indentation position for each line of code.

The BytecodeProject can be used by the client to inspect .class files or to instruct the project of compiled libraries that a java project might import.


## 3.1 Project

TODO


## 3.2 Compilation Request

When the project handler dispatches a compilation request to the project, the compilation request buffer is compiled by a specific sub-project instance: java or bytecode sub-project.

The emacs output generated by the compilation is set in the compilation request output. Then, the project handler prepares the response object that the server will deliver to the client using the compilation unit object.
