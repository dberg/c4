## 1.0 C4

C4 is a collection of tools to provide source code information for editing java and scala projects.

C4 includes two emacs modes: c4j-mode (java) and c4s-mode (scala); a server to process projects and parsers for java, scala and jvm bytecode.


## 2.0 Server

The server is responsible for the data flow between emacs clients and projects residing on the server. The server uses non-blocking I/O (epoll or kqueue) and the data exchanged with clients is serialized and deserialized using Protocol Buffers.

The server maintains a RequestBuffer object per connection until it has the complete data to form a request object. After a request object is built the server delivers the request to the ProjectHandler object. The ProjectHandler object is responsible to deliver the request to its project. If no project exists the ProjectHandler creates one.

The project process the requests and returns response objects which the server delivers to the client.


### 2.1 Data stream

The bytestream sent between the client and the server is serialized and deserialized using the auto-generated classes Request and Response. The first 4 bytes in the bytestream, in network byte order, indicates the length of the serialized Request or Response.


###  2.2 Request

Every request must set the attributes "projectId" and "action". The projectId attribute must be generated by the client and it should be unique per project. The action attribute can be of two types: PROJECT and COMPILE.

PROJECT: A client issues this method to query the status of the project. The server will indicate if it has all the compilation units of the project and if not which symbols are missing.

COMPILE: The client issues this method to send a list of compilation units to be parsed by the project.


### 2.3 Response

A response consists of a response code and a body. The response code indicates if a request terminated in success or error.

Successful response codes are OK_PROJECT and OK_COMPILE.

If the response code is an error the body contains an error message. And if the response code is success the body contains information depending on the action of the request.

If the action is PROJECT the body of the response contains information about the project. If the action is COMPILE the body of the response contains information about the list of compilation units processed by the server.


## 3.0 Projects

A project instance is identified by a projectId that is generated by the client. A project is a global container for 3 specialized projects: JavaProject, ScalaProject and BytecodeProject.

A java or scala project instance contain a list of compilation units. Each compilation unit is identified by its filename. After being processed the compilation unit object should have a symbol table and basic information about the source file like syntax highlighting and the indentation position for each line of code.

The BytecodeProject can be used by the client to inspect .class files or to instruct the project of compiled libraries that a java or scala project might import.


## 3.1 Project

TODO


## 3.2 Compilation Units

When the project handler dispatches a compilation request to the project, each compilation unit is compiled by a specific project instances: java, scala or bytecode. The emacs output generated by each compilation unit is set in the compilation unit itself. Then, the project handler prepares the response object that the server will deliver to the client.